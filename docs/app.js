(()=>{"use strict";var t=window.location.search.indexOf("debug")>0,e=document.getElementById("canvas"),r=e.getContext("2d"),n=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}],o={state:"paused",width:0,height:0,wormWidth:0,maxWormLength:0,worm:[],heading:0,speed:0,test:null,points:0,level:0},a=function(t){var e=t.x,r=t.y;return function(t){var n=t.x,o=t.y,a=e-n,i=r-o;return Math.sqrt(a*a+i*i)}},i=function(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)},s=function(t,e,r){var n=(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y);return 0===n?0:n>0?1:2},u=function(t){var e,r,n,i,s,u,f,h,c=[],d=3+Math.round(3*Math.random()),l=(r=o.width,n=o.height,i=o.worm,s=o.wormWidth,u=3*s,f=[i[0]],h=function(t){var e=a(t);return f.every((function(t){return e(t)>u}))},function(){for(;;){var t={x:Math.random()*(r-4*s)+2*s,y:Math.random()*(n-4*s)+2*s};if(h(t))return f.push(t),t}}),m=1+Math.floor(5*Math.random()),x=1+Math.floor(5*Math.random()),v=m+x,g=(e=v,function(){for(;;){var t=1+Math.floor(10*Math.random());if(t!==e)return t}});c.push({name:v.toString(10),correct:!0,position:l()});for(var w=0;w<d;w++)c.push({name:g().toString(10),correct:!1,position:l()});return{question:m+" + "+x,answer:""+v,started:t,timeout:t+3e4,options:c}},f=2*Math.PI,h=function(t,e,n){return r.fillText(n,t-.5*function(t){return r.measureText(t).width}(n),e)},c=function(t){r.save(),r.font="32px PressStart",r.textBaseline="hanging",r.fillStyle="rgba(192, 192, 192, 192)",h(.5*o.width,o.height/2,t),r.restore()},d=function(){var e,n,a=o.width,i=o.height,s=o.state;switch(r.clearRect(0,0,a,i),function(){r.save(),r.lineJoin="round",r.lineCap="round",r.lineWidth=o.wormWidth,r.strokeStyle="run"===o.state?"#ff00ff":"#770077",r.beginPath();var t=o.worm,e=t[0];e&&r.moveTo(e.x,e.y);for(var n=1;n<t.length;n++){var a=t[n],i=a.x,s=a.y;r.lineTo(i,s)}r.stroke(),r.restore()}(),e=o.wormWidth,n=o.points,r.save(),r.font=(.6*e).toFixed(1)+"px PressStart",r.textBaseline="middle",r.fillStyle="run"===o.state?"#50ff50":"#207720",r.fillText("points: "+n,e,e),r.restore(),s){case"run":!function(){var t=o.test,e=o.wormWidth,n=o.width;t&&(r.save(),r.font=(.6*e).toFixed(1)+"px PressStart",r.textBaseline="middle",r.fillStyle="run"===o.state?"#ffffff":"#777777",h(.5*n,e,t.question),r.fillStyle="run"===o.state?"#ffffff":"#777777",r.strokeStyle="run"===o.state?"#ffffff":"#777777",r.lineWidth=2,t.options.forEach((function(t){var e=t.name,n=t.position,a=n.x,i=n.y,s=.5*r.measureText(e).width;r.fillText(e,a-s,i),r.beginPath(),r.arc(a,i,o.wormWidth,0,f,!1),r.stroke()})),r.restore())}();break;case"paused":c("paused");break;case"game-over":c("game over")}t&&function(){var t=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),o=0;for(e=0;e<r;e++)for(var a=arguments[e],i=0,s=a.length;i<s;i++,o++)n[o]=a[i];return n}(["state:    "+o.state,"speed:    "+o.speed,"length:   "+o.maxWormLength,"worm-w:   "+o.wormWidth.toFixed(1)],o.worm.map((function(t,e){var r=t.x,n=t.y;return(0===e?"worm:    ":"         ")+" ["+e+"] "+r.toFixed(0)+" : "+n.toFixed(0)}))),e=20;r.save(),r.font="16px courier",r.textBaseline="hanging",r.fillStyle="rgba(128, 128, 128, 128)";for(var n=0,a=t;n<a.length;n++){var i=a[n];r.fillText(i,20,e),e+=18}r.restore()}()},l=function(t){var e=new Audio("sounds/"+t+".mp3");return function(){e.play().catch((function(t){return console.error(t)}))}},m=l("crash"),x=l("squeak"),v=l("chaching"),g=function(t){(function(){var t=o.worm,e=n[o.heading],r=o.speed,a=t[0],u=a.x,f=a.y,h=o.wormWidth,c=h/2,d=o.maxWormLength,l=0,x=u+e.x*r,v=f+e.y*r;if(a.x=x,a.y=v,x<c||x>o.width-c||v<c||v>o.height-c)return m(),void(o.state="game-over");for(var g=t[0],w=t[1],y=function(t,e){return function(r,n){var o=s(t,e,r),a=s(t,e,n),u=s(r,n,t),f=s(r,n,e);return o!==a&&u!==f||!(0!==o||!i(t,r,e))||!(0!==a||!i(t,n,e))||!(0!==u||!i(r,t,n))||!(0!==f||!i(r,e,n))}}({x:g.x+e.x*h,y:g.y+e.y*h},w),p=3;p<t.length;p++)if(y(t[p-1],t[p]))return m(),void(o.state="game-over");for(p=1;p<t.length;p++){var M=t[p],W=M.x,S=M.y,b=x-W,k=v-S;if((l+=Math.abs(b)+Math.abs(k))>d){var T=d-l;0!==b&&(M.x+=T*(b>0?-1:1)),0!==k&&(M.y+=T*(k>0?-1:1)),t.splice(p+1);break}x=W,v=S}})(),function(t){var e=o.wormWidth,r=o.test,n=o.worm;if(r){var i=r.options,s=a(n[0]),f=1.5*e,h=i.findIndex((function(t){var e=t.position;return s(e)<f})),c=i[h];c&&(c.correct?(v(),o.points+=1,o.test=u(t)):(x(),i.splice(h,1),console.log("WRONG",h,c.name)))}}(t)},w=function(){return(w=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},y=function(){var t=.5*o.width,e=.5*o.height;o.state="run",o.maxWormLength=300,o.worm=[{x:t,y:e},{x:t,y:e}],o.heading=0,o.speed=1.5,o.test=u(Date.now()),o.points=0,o.level=0},p=function(t){"run"===o.state&&(o.heading=function(t,e){var r=t+e;return r<0?3:r>3?0:r}(o.heading,t),o.worm.unshift(w({},o.worm[0])))},M={run:function(){return o.state="paused"},paused:function(){return o.state="run"},"game-over":function(){return y()}};document.addEventListener("keydown",(function(e){var r=e.code,n=e.repeat;if(!n)switch(r){case"ArrowRight":return p(1);case"ArrowLeft":return p(-1);case"Space":return M[o.state]();case"KeyD":return t=!t;default:console.log("key: "+r+" ("+n+")")}}));var W=function(){var t=e.clientWidth,r=e.clientHeight;e.width=t,e.height=r,o.width=t,o.height=r,o.wormWidth=.02*t,"run"!==o.state&&d()};window.addEventListener("resize",W),W();var S=function(t){"run"===o.state&&g(t),d(),window.requestAnimationFrame(S)};y(),S(Date.now())})();