(()=>{"use strict";var t="true"===new URLSearchParams(window.location.search).get("debug"),e=document.getElementById("game"),n=e.getContext("2d"),r="ontouchstart"in document.documentElement,a=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}],o={state:"paused",width:0,height:0,wormWidth:0,maxWormLength:0,worm:[],heading:0,speed:0,test:null,points:0,level:0,tick:0},i={x:0,y:0,r:0,dx:0,dy:0,selected:null,tx:null,ty:null},l=function(t){var e=t.x,n=t.y;return function(t){var r=t.x,a=t.y,o=e-r,i=n-a;return Math.sqrt(o*o+i*i)}},s=function(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)},u=function(t,e,n){var r=(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y);return 0===r?0:r>0?1:2},c=function(){var t,e,n,r,a,i,s,u,c=[],f=3+Math.round(3*Math.random()),h=(e=o.width,n=o.height,r=o.worm,a=o.wormWidth,i=3*a,s=[r[0]],u=function(t){var e=l(t);return s.every((function(t){return e(t)>i}))},function(){for(;;){var t={x:Math.random()*(e-4*a)+2*a,y:Math.random()*(n-4*a)+2*a};if(u(t))return s.push(t),t}}),d=1+Math.floor(5*Math.random()),v=1+Math.floor(5*Math.random()),m=d+v,g=(t=m,function(){for(;;){var e=1+Math.floor(10*Math.random());if(e!==t)return e}});c.push({name:m.toString(10),correct:!0,position:h()});for(var x=0;x<f;x++)c.push({name:g().toString(10),correct:!1,position:h()});return{question:d+" + "+v,answer:""+m,created:o.tick,options:c}},f=!1,h=[],d=!1,v=function(t){var e=new Audio;return h.push([e,"sounds/"+t+".mp3"]),function(){f&&e.play().catch((function(t){return console.error(t)}))}},m=v("crash"),g=v("squeak"),x=v("chaching"),p=function(){return f},y=function(){n.save(),n.lineJoin="round",n.lineCap="round",n.lineWidth=o.wormWidth,n.strokeStyle="run"===o.state?"#ff00ff":"#770077",n.beginPath();var t=o.worm,e=t[0];e&&n.moveTo(e.x,e.y);for(var r=1;r<t.length;r++){var a=t[r],i=a.x,l=a.y;n.lineTo(i,l)}n.stroke(),n.restore()},w=Math.PI,k=2*w,b=.5*w,S=.25*w,M=function(t,e,r){return n.fillText(r,t-.5*function(t){return n.measureText(t).width}(r),e)},P=function(){var t=o.test,e=o.wormWidth,r=o.width;t&&(n.save(),n.font=(1.2*e).toFixed(1)+"px PressStart",n.textBaseline="middle",n.fillStyle="run"===o.state?"#ffffff":"#777777",M(.5*r,e,t.question),n.font=(.8*e).toFixed(1)+"px sans-serif",n.fillStyle="run"===o.state?"#ffffff":"#777777",n.strokeStyle="run"===o.state?"#ffffff":"#777777",n.lineWidth=2,t.options.forEach((function(t){var e=t.name,r=t.position,a=r.x,i=r.y,l=.5*n.measureText(e).width;n.fillText(e,a-l,i),n.beginPath(),n.arc(a,i,o.wormWidth,0,k,!1),n.stroke()})),n.restore())},W=function(){var t=o.wormWidth,e=o.points;n.save(),n.font=(1.2*t).toFixed(1)+"px PressStart",n.textBaseline="middle",n.fillStyle="run"===o.state?"#50ff50":"#207720",n.fillText("Pisteet: "+e,t,t),n.restore()},T=r?function(){var t=i.r,e=i.x,r=i.y,a=i.selected,l="rgba(255, 255, 255, 0.05)",s="rgba(255, 255, 255, 0.1)";n.save(),n.translate(e,r);for(var u=0;u<4;u++)n.fillStyle=u===a?"rgba(255, 255, 255, 0.7)":l,n.strokeStyle=u===a?"rgba(255, 255, 255, 1)":s,n.beginPath(),n.arc(0,0,t,w+S,k-S,!1),n.arc(0,0,.4*t,k-S,w+S,!0),n.closePath(),n.fill(),n.stroke(),n.rotate(b);n.scale(.4*t,.4*t),n.fillStyle=l,n.strokeStyle=s,"run"===o.state?(n.fillRect(-.3,-.6,.2,1.2),n.fillRect(.1,-.6,.2,1.2)):(n.beginPath(),n.moveTo(-.3,-.5),n.lineTo(.6,0),n.lineTo(-.3,.5),n.closePath(),n.fill()),n.restore()}:function(){},L=function(e){var a=o.width,i=o.height,l=o.state;switch(n.clearRect(0,0,a,i),l){case"new":r?function(t){var e=1-Math.abs(t%2e3-1e3)/1e3,r=.5*o.width,a=1.6*o.wormWidth,i=o.height/2-6*a;n.save(),n.textBaseline="hanging",n.font="32px PressStart",n.fillStyle="rgba(127, 255, 127, "+e+")",M(r,i,"Matikka-Mato"),i+=a,i+=a,i+=a,n.fillStyle="rgb(127, 255, 212)",n.font="16px PressStart",M(r,i,"Ohjaa matoa oikean vastauksen luo."),M(r,i+=a,"Älä törmaa seinään tai matoon."),i+=a,M(r,i+=a,"Ohjaa matoa koskettamalla ohjainta."),M(r,i+=a,"Aloita peli ohjaimen keskeltä."),n.restore()}(e):function(t){var e=1-Math.abs(t%2e3-1e3)/1e3,r=.5*o.width,a=1.6*o.wormWidth,i=o.height/2-6*a;n.save(),n.textBaseline="hanging",n.font="32px PressStart",n.fillStyle="rgba(127, 255, 127, "+e+")",M(r,i,"Matikka-Mato"),i+=a,i+=a,i+=a,n.fillStyle="rgb(127, 255, 212)",n.font="16px PressStart",M(r,i,"Ohjaa mato oikean vastauksen luo."),M(r,i+=a,"Älä törmaa seinään tai matoon."),i+=a,M(r,i+=a,"Ohjaa matoa nuoli-näppäimillä."),M(r,i+=a,"Aloita peli välilyönnillä."),n.restore()}(e),function(){var t=o.width,e=o.wormWidth,r="rgba(0, 255, 0, 1)",a="rgba(0, 192, 0, 1)";n.save(),n.translate(t-3*e,e),n.scale(2*e,2*e),n.lineWidth=.08,n.lineJoin="round",n.strokeStyle=p()?r:"rgba(64, 128, 64, 1)",n.fillStyle=a,n.beginPath(),n.moveTo(.1,.35),n.lineTo(.3,.35),n.lineTo(.55,.15),n.lineTo(.55,.85),n.lineTo(.3,.65),n.lineTo(.1,.65),n.closePath(),p()&&n.fill(),n.stroke(),n.beginPath(),n.arc(.5,.5,.3,-1,1,!1),n.stroke(),n.beginPath(),n.arc(.5,.5,.45,-1,1,!1),n.stroke(),n.restore(),n.save(),n.translate(t-2*e,4.5*e),n.scale(e,e),n.lineWidth=.08,n.lineJoin="round",n.strokeStyle=r,n.fillStyle=a;for(var i=0;i<4;i++)n.beginPath(),n.moveTo(1.1,0),n.lineTo(.8,.3),n.lineTo(.8,.2),n.lineTo(.4,.2),n.lineTo(.4,-.2),n.lineTo(.8,-.2),n.lineTo(.8,-.3),n.closePath(),n.stroke(),n.rotate(b);n.restore()}();break;case"run":y(),W(),P();break;case"paused":W(),function(t){var e=1-Math.abs(t%2e3-1e3)/1e3,r=.5*o.width,a=1.6*o.wormWidth,i=o.height/2-2*a;n.save(),n.font="32px PressStart",n.textBaseline="hanging",n.fillStyle="rgba(255, 255, 255, "+e+")",M(r,i,"paused"),i+=a,i+=a,n.font="26px PressStart",M(r,i,"press space or click"),M(r,i+=a,"to continue"),n.restore()}(e);break;case"game-over":y(),P(),function(t){var e=1-Math.abs(t%2e3-1e3)/1e3,a=.5*o.width,i=1.8*o.wormWidth,l=o.height/2-4*i;n.save(),n.font="32px PressStart",n.textBaseline="hanging",n.fillStyle="rgba(127, 255, 127, "+e+")",M(a,l,"game over"),l+=i,l+=i,n.fillStyle="rgba(127, 255, 212, "+e+")",n.font="48px PressStart",M(a,l,"Sait "+o.points+" pistettä"),l+=i,l+=i,n.fillStyle="rgba(127, 255, 127, "+e+")",n.font="26px PressStart",r?(M(a,l,"Aloita uusi peli painamalla"),M(a,l+=i,"ohjaimen keskeltä.")):(M(a,l,"Aloita uusi peli painamalla"),M(a,l+=i,"välilyöntiä.")),n.restore()}(e)}T(),t&&function(){var t=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),a=0;for(e=0;e<n;e++)for(var o=arguments[e],i=0,l=o.length;i<l;i++,a++)r[a]=o[i];return r}(["state:    "+o.state,"speed:    "+o.speed.toFixed(3),"mobile:   "+r,"scale:    "+o.wormWidth.toFixed(1),"screen:   "+o.width+" x "+o.height,"test-age: "+((o.test?o.tick-o.test.created:0)/1e3).toFixed(1),"length:   "+o.maxWormLength.toFixed(1)],o.worm.map((function(t,e){var n=t.x,r=t.y;return(0===e?"worm:    ":"         ")+" ["+e+"] "+n.toFixed(0)+" : "+r.toFixed(0)}))),e=40;n.save(),n.font="16px courier",n.textBaseline="hanging",n.fillStyle="rgba(128, 128, 128, 128)";for(var a=0,i=t;a<i.length;a++){var l=i[a];n.fillText(l,20,e),e+=18}n.restore()}()},E=function(){return(E=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},A=function(){var t=.5*o.width,e=.5*o.height;o.state="new",o.maxWormLength=300,o.worm=[{x:t,y:e},{x:t,y:e}],o.heading=0,o.speed=o.width/1200*.07,o.test=c(),o.points=0,o.level=0,o.tick=0},D=[[0,1,0,3],[0,1,2,1],[2,1,2,3],[0,3,2,3]],F=function(t){var e=o.state,n=o.heading;if("run"===e){var r=D[n][t];r!==n&&(o.heading=r,o.worm.unshift(E({},o.worm[0])))}},j=function(){o.tick=0,o.state="run"},B=function(){o.state="paused"},q={new:j,run:B,paused:j,"game-over":A};document.addEventListener("keydown",(function(e){var n=e.code,r=e.repeat;if(!r)switch(n){case"ArrowUp":return e.preventDefault(),F(0);case"ArrowRight":return e.preventDefault(),F(1);case"ArrowDown":return e.preventDefault(),F(2);case"ArrowLeft":return e.preventDefault(),F(3);case"Space":return e.preventDefault(),q[o.state]();case"Escape":return e.preventDefault(),A();case"KeyD":return e.preventDefault(),t=!t;default:console.log("key: "+n+" ("+r+")")}}));var O={new:j,run:B,paused:j,"game-over":A},R=function(t,e){var n=o.width,r=o.wormWidth,a=i.x,l=i.y,s=i.r,u=i.dx,c=i.dy,v=t-u,m=e-c,g=v-a,x=m-l,p=.2*s,y=n-3*r,w=4.5*r,k=w+2*r;if(v>=y&&v<=y+r){if(m>=r&&m<=r+2*r)return d||(h.forEach((function(t){var e=t[0],n=t[1];return e.src=n})),d=!0),void(f=!f);if(m>=w&&m<=k)return void console.log("fullscreen!",Date.now())}return Math.abs(g)>s||Math.abs(x)>s?(i.tx=null,i.ty=null,void(i.selected=null)):(i.tx=t-u,i.ty=e-c,Math.abs(x)<p&&Math.abs(g)<p?(i.selected=null,void O[o.state]()):(Math.abs(x)<Math.abs(g)?i.selected=g<0?3:1:i.selected=x<0?0:2,void F(i.selected)))},C=function(t){t.preventDefault(),t.stopPropagation();var e=t.touches[0],n=null==e?void 0:e.clientX,r=null==e?void 0:e.clientY;n&&r&&R(n,r)},I=function(t){t.preventDefault(),t.stopPropagation(),i.tx=null,i.ty=null,i.selected=null};e.addEventListener("touchstart",C),e.addEventListener("touchmove",C),e.addEventListener("touchend",I),e.addEventListener("mousedown",(function(t){t.preventDefault(),R(t.clientX,t.clientY)})),e.addEventListener("mouseup",I),e.addEventListener("mouseout",I),e.addEventListener("mouseleave",I);var J=function(){var t=document.documentElement,n=t.clientWidth,r=t.clientHeight,a=e.getBoundingClientRect(),l=.02*n;e.width=n,e.height=r,o.width=n,o.height=r,o.wormWidth=l,i.r=.2*r,i.x=n-i.r-l,i.y=r-i.r-l,i.dx=a.left+4,i.dy=a.top+4,i.selected=null};window.addEventListener("resize",J);var U=function(t){0===o.tick&&(o.tick=t),"run"===o.state&&function(t){var e=t-o.tick;o.tick=t,function(t){var e=o.worm,n=a[o.heading],r=o.speed,i=e[0],l=i.x,c=i.y,f=o.wormWidth,h=f/2,d=o.maxWormLength,v=0,g=l+n.x*r*t,x=c+n.y*r*t;if(i.x=g,i.y=x,g<h||g>o.width-h||x<h||x>o.height-h)return m(),void(o.state="game-over");for(var p=e[0],y=e[1],w=function(t,e){return function(n,r){var a=u(t,e,n),o=u(t,e,r),i=u(n,r,t),l=u(n,r,e);return a!==o&&i!==l||!(0!==a||!s(t,n,e))||!(0!==o||!s(t,r,e))||!(0!==i||!s(n,t,r))||!(0!==l||!s(n,e,r))}}({x:p.x+n.x*f,y:p.y+n.y*f},y),k=3;k<e.length;k++)if(w(e[k-1],e[k]))return m(),void(o.state="game-over");for(k=1;k<e.length;k++){var b=e[k],S=b.x,M=b.y,P=g-S,W=x-M;if((v+=Math.abs(P)+Math.abs(W))>d){var T=d-v;0!==P&&(b.x+=T*(P>0?-1:1)),0!==W&&(b.y+=T*(W>0?-1:1)),e.splice(k+1);break}g=S,x=M}}(e),function(t){var e=o.wormWidth,n=o.test,r=o.worm;if(n){var a,i,s=n.options,u=l(r[0]),f=1.5*e,h=s.findIndex((function(t){var e=t.position;return u(e)<f})),d=s[h];d&&(d.correct?function(t,e,n){x(),o.points+=1,o.speed*=1.06,o.maxWormLength*=1.07,o.test=c(),console.log("correct:",((o.tick-t.created)/1e3).toFixed(1))}(n):(a=h,g(),null===(i=o.test)||void 0===i||i.options.splice(a,1)))}}()}(t),L(t),window.requestAnimationFrame(U)};window.requestAnimationFrame((function(){J(),A(),window.requestAnimationFrame(U)}))})();