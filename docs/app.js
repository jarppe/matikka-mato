(()=>{"use strict";var t="true"===new URLSearchParams(window.location.search).get("debug"),e=document.getElementById("canvas"),r=e.getContext("2d"),n=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}],a={state:"paused",width:0,height:0,wormWidth:0,maxWormLength:0,worm:[],heading:0,speed:0,test:null,points:0,level:0,tick:0},i=new Array(30),o=0,s=function(t){var e=t.x,r=t.y;return function(t){var n=t.x,a=t.y,i=e-n,o=r-a;return Math.sqrt(i*i+o*o)}},u=function(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)},f=function(t,e,r){var n=(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y);return 0===n?0:n>0?1:2},c=function(){var t,e,r,n,i,o,u,f,c=[],h=3+Math.round(3*Math.random()),l=(e=a.width,r=a.height,n=a.worm,i=a.wormWidth,o=3*i,u=[n[0]],f=function(t){var e=s(t);return u.every((function(t){return e(t)>o}))},function(){for(;;){var t={x:Math.random()*(e-4*i)+2*i,y:Math.random()*(r-4*i)+2*i};if(f(t))return u.push(t),t}}),d=1+Math.floor(5*Math.random()),x=1+Math.floor(5*Math.random()),v=d+x,m=(t=v,function(){for(;;){var e=1+Math.floor(10*Math.random());if(e!==t)return e}});c.push({name:v.toString(10),correct:!0,position:l()});for(var g=0;g<h;g++)c.push({name:m().toString(10),correct:!1,position:l()});return{question:d+" + "+x,answer:""+v,created:a.tick,options:c}},h=2*Math.PI,l=function(t,e,n){return r.fillText(n,t-.5*function(t){return r.measureText(t).width}(n),e)},d=function(e){var n,o,s=a.width,u=a.height,f=a.state;switch(r.clearRect(0,0,s,u),function(){r.save(),r.lineJoin="round",r.lineCap="round",r.lineWidth=a.wormWidth,r.strokeStyle="run"===a.state?"#ff00ff":"#770077",r.beginPath();var t=a.worm,e=t[0];e&&r.moveTo(e.x,e.y);for(var n=1;n<t.length;n++){var i=t[n],o=i.x,s=i.y;r.lineTo(o,s)}r.stroke(),r.restore()}(),n=a.wormWidth,o=a.points,r.save(),r.font=(.6*n).toFixed(1)+"px PressStart",r.textBaseline="middle",r.fillStyle="run"===a.state?"#50ff50":"#207720",r.fillText("points: "+o,n,n),r.restore(),f){case"new":!function(t){var e=1-Math.abs(t%2e3-1e3)/1e3,n=.5*a.width,i=1.6*a.wormWidth,o=a.height/2-6*i;r.save(),r.textBaseline="hanging",r.font="32px PressStart",r.fillStyle="rgba(127, 255, 127, "+e+")",l(n,o,"Matikka-Mato"),o+=i,o+=i,o+=i,r.fillStyle="rgb(127, 255, 212)",r.font="16px PressStart",l(n,o,"ohjaa matoa oikean vastauksen luo"),o+=i,l(n,o+=i,"mato kääntyy <- ja -> näppäimillä"),l(n,o+=i,"tai hiirellä klikkaamalla ruudun"),l(n,o+=i,"vasenta tai oikeaa puolta"),o+=i,l(n,o+=i,"välilyönti aloittaa ja lopettaa tauon"),o+=i,l(n,o+=i,"aloita välilyönnillä"),r.restore()}(e);break;case"run":!function(){var t=a.test,e=a.wormWidth,n=a.width;t&&(r.save(),r.font=(1.2*e).toFixed(1)+"px PressStart",r.textBaseline="middle",r.fillStyle="run"===a.state?"#ffffff":"#777777",l(.5*n,e,t.question),r.font=(.8*e).toFixed(1)+"px sans-serif",r.fillStyle="run"===a.state?"#ffffff":"#777777",r.strokeStyle="run"===a.state?"#ffffff":"#777777",r.lineWidth=2,t.options.forEach((function(t){var e=t.name,n=t.position,i=n.x,o=n.y,s=.5*r.measureText(e).width;r.fillText(e,i-s,o),r.beginPath(),r.arc(i,o,a.wormWidth,0,h,!1),r.stroke()})),r.restore())}();break;case"paused":!function(t){var e=1-Math.abs(t%2e3-1e3)/1e3,n=.5*a.width,i=1.6*a.wormWidth,o=a.height/2-2*i;r.save(),r.font="32px PressStart",r.textBaseline="hanging",r.fillStyle="rgba(255, 255, 255, "+e+")",l(n,o,"paused"),o+=i,o+=i,r.font="26px PressStart",l(n,o,"press space or click"),l(n,o+=i,"to continue"),r.restore()}(e);break;case"game-over":!function(t){var e=1-Math.abs(t%2e3-1e3)/1e3,n=.5*a.width,i=1.8*a.wormWidth,o=a.height/2-4*i;r.save(),r.font="32px PressStart",r.textBaseline="hanging",r.fillStyle="rgba(127, 255, 127, "+e+")",l(n,o,"game over"),o+=i,o+=i,r.fillStyle="rgba(127, 255, 212, "+e+")",r.font="48px PressStart",l(n,o,"score "+a.points),o+=i,o+=i,r.fillStyle="rgba(127, 255, 127, "+e+")",r.font="26px PressStart",l(n,o,"press space or click"),l(n,o+=i,"for new game"),r.restore()}(e)}t&&function(){var t=function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),a=0;for(e=0;e<r;e++)for(var i=arguments[e],o=0,s=i.length;o<s;o++,a++)n[a]=i[o];return n}(["state:    "+a.state,"speed:    "+a.speed.toFixed(3),"fps:      "+(1e3/(i.reduce((function(t,e){return t+e}),0)/30)).toFixed(1),"size:     "+a.width+" x "+a.height,"length:   "+a.maxWormLength.toFixed(1),"worm-w:   "+a.wormWidth.toFixed(1),"test-age: "+((a.test?a.tick-a.test.created:0)/1e3).toFixed(1)],a.worm.map((function(t,e){var r=t.x,n=t.y;return(0===e?"worm:    ":"         ")+" ["+e+"] "+r.toFixed(0)+" : "+n.toFixed(0)}))),e=40;r.save(),r.font="16px courier",r.textBaseline="hanging",r.fillStyle="rgba(128, 128, 128, 128)";for(var n=0,o=t;n<o.length;n++){var s=o[n];r.fillText(s,20,e),e+=18}r.restore()}()},x="false"!==new URLSearchParams(window.location.search).get("sound")?function(t){var e=new Audio("sounds/"+t+".mp3");return function(){e.play().catch((function(t){return console.error(t)}))}}:function(t){return function(){console.log("play:",t)}},v=x("crash"),m=x("squeak"),g=x("chaching"),w=function(t){var e=t-a.tick;a.tick=t,function(t){i[o++]=t,o>30&&(o=0)}(e),function(t){var e=a.worm,r=n[a.heading],i=a.speed,o=e[0],s=o.x,c=o.y,h=a.wormWidth,l=h/2,d=a.maxWormLength,x=0,m=s+r.x*i*t,g=c+r.y*i*t;if(o.x=m,o.y=g,m<l||m>a.width-l||g<l||g>a.height-l)return v(),void(a.state="game-over");for(var w=e[0],p=e[1],y=function(t,e){return function(r,n){var a=f(t,e,r),i=f(t,e,n),o=f(r,n,t),s=f(r,n,e);return a!==i&&o!==s||!(0!==a||!u(t,r,e))||!(0!==i||!u(t,n,e))||!(0!==o||!u(r,t,n))||!(0!==s||!u(r,e,n))}}({x:w.x+r.x*h,y:w.y+r.y*h},p),k=3;k<e.length;k++)if(y(e[k-1],e[k]))return v(),void(a.state="game-over");for(k=1;k<e.length;k++){var S=e[k],M=S.x,b=S.y,W=m-M,P=g-b;if((x+=Math.abs(W)+Math.abs(P))>d){var F=d-x;0!==W&&(S.x+=F*(W>0?-1:1)),0!==P&&(S.y+=F*(P>0?-1:1)),e.splice(k+1);break}m=M,g=b}}(e),function(t){var e=a.wormWidth,r=a.test,n=a.worm;if(r){var i,o,u=r.options,f=s(n[0]),h=1.5*e,l=u.findIndex((function(t){var e=t.position;return f(e)<h})),d=u[l];d&&(d.correct?function(t,e,r){g(),a.points+=1,a.speed*=1.1,a.maxWormLength*=1.07,a.test=c(),console.log("correct:",((a.tick-t.created)/1e3).toFixed(1))}(r):(i=l,m(),null===(o=a.test)||void 0===o||o.options.splice(i,1)))}}()},p=function(){return(p=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var a in e=arguments[r])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},y=function(){var t=.5*a.width,e=.5*a.height;a.state="new",a.maxWormLength=300,a.worm=[{x:t,y:e},{x:t,y:e}],a.heading=0,a.speed=a.width/1200*.05,a.test=c(),a.points=0,a.level=0,a.tick=0},k=function(t){"run"===a.state&&(a.heading=function(t,e){var r=t+e;return r<0?3:r>3?0:r}(a.heading,t),a.worm.unshift(p({},a.worm[0])))},S={new:function(){a.tick=0,a.state="run"},run:function(){a.state="paused"},paused:function(){a.tick=0,a.state="run"},"game-over":function(){y()}};document.addEventListener("keydown",(function(e){var r=e.code,n=e.repeat;if(!n)switch(r){case"ArrowRight":return k(1);case"ArrowLeft":return k(-1);case"Space":return S[a.state]();case"Escape":return y();case"KeyD":return t=!t;default:console.log("key: "+r+" ("+n+")")}}));var M=function(){var t=e.clientWidth,r=e.clientHeight;e.width=t,e.height=r,a.width=t,a.height=r,a.wormWidth=.02*t};window.addEventListener("resize",M),M(),e.addEventListener("touchstart",(function(t){var e=a.state,r=a.width,n=.3*r,i=.7*r;if(t.preventDefault(),"run"===e){var o=t.touches[0],s=null==o?void 0:o.clientX;if(s<n)return k(-1);if(s>i)return k(1)}return S[e]()}));var b=function(t){0===a.tick&&(a.tick=t),"run"===a.state&&w(t),d(t),window.requestAnimationFrame(b)};y(),window.requestAnimationFrame(b)})();